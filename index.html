<!DOCTYPE html>
<html lang="ru">

<head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Увалы</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
        }

        .calendar-grid {
            display: grid;
            grid-template-columns: repeat(7, minmax(0, 1fr));
        }

        @keyframes spin {
            to {
                transform: rotate(360deg);
            }
        }

        .loader {
            border: 4px solid rgba(0, 0, 0, 0.1);
            border-left-color: #8b5cf6;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
        }

        /* Убираем стандартную стрелку у select */
        select {
            -webkit-appearance: none;
            -moz-appearance: none;
            appearance: none;
            background-image: url("data:image/svg+xml;charset=UTF-8,%3csvg xmlns='http://www.w3.org/2000/svg' fill='none' viewBox='0 0 20 20'%3e%3cpath stroke='%236b7280' stroke-linecap='round' stroke-linejoin='round' stroke-width='1.5' d='m6 8 4 4 4-4'/%3e%3c/svg%3e");
            background-position: right 0.5rem center;
            background-repeat: no-repeat;
            background-size: 0.1em 0.1em;
            padding-right: 2.25rem;
        }
    </style>
    <script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>

<body class="bg-gradient-to-br from-indigo-50 to-purple-50">
    <div id="root"></div>

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

    <script type="text/babel">
        const { useState, useEffect, useMemo, useCallback } = React;

        const SCHEDULE_API_URL = "https://kvdb.io/XXNk2AAo7MEDxed7bQD9NN/schedule";

        const NAMES = [
            'ТЕСЛА', 'НИК', 'НАТО'
        ];

        const App = () => {
            const [currentDate, setCurrentDate] = useState(new Date());
            const [schedule, setSchedule] = useState({});
            const [isLoading, setIsLoading] = useState(true);
            const [isSaving, setIsSaving] = useState(false);

            const today = useMemo(() => {
                const d = new Date();
                d.setHours(0, 0, 0, 0);
                return d;
            }, []);

            useEffect(() => {
                const fetchSchedule = async () => {
                    setIsLoading(true);
                    try {
                        const response = await fetch(SCHEDULE_API_URL, { cache: 'no-cache' });
                        if (response.ok) {
                            const data = await response.json();
                            setSchedule(data);
                        } else if (response.status !== 404) {
                            throw new Error(`HTTP error! status: ${response.status}`);
                        }
                    } catch (error) {
                        console.error("Не удалось загрузить график:", error);
                    } finally {
                        setIsLoading(false);
                    }
                };
                fetchSchedule();
            }, []);

            const saveSchedule = useCallback(async (newSchedule) => {
                setIsSaving(true);
                try {
                    await fetch(SCHEDULE_API_URL, {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify(newSchedule)
                    });
                } catch (error) {
                    console.error("Ошибка сохранения графика:", error);
                } finally {
                    setIsSaving(false);
                }
            }, []);

            const handleSelectPerson = useCallback((date, person) => {
                const key = date.toISOString().split('T')[0];
                setSchedule(prevSchedule => {
                    const newSchedule = { ...prevSchedule };
                    if (person) {
                        newSchedule[key] = person;
                    } else {
                        delete newSchedule[key];
                    }
                    saveSchedule(newSchedule);
                    return newSchedule;
                });
            }, [saveSchedule]);

            const changeMonth = (offset) => {
                setCurrentDate(prevDate => {
                    const newDate = new Date(prevDate.getFullYear(), prevDate.getMonth() + offset, 1);
                    return newDate;
                });
            };

            const calendarDays = useMemo(() => {
                const year = currentDate.getFullYear();
                const month = currentDate.getMonth();
                const firstDayOfMonth = new Date(year, month, 1);
                const lastDayOfMonth = new Date(year, month + 1, 0);
                const daysInMonth = lastDayOfMonth.getDate();
                const startDayOfWeek = (firstDayOfMonth.getDay() + 6) % 7;
                const days = [];

                const prevMonthLastDay = new Date(year, month, 0).getDate();
                for (let i = startDayOfWeek; i > 0; i--) {
                    days.push({ date: new Date(year, month - 1, prevMonthLastDay - i + 1), isCurrentMonth: false });
                }
                for (let i = 1; i <= daysInMonth; i++) {
                    const date = new Date(year, month, i);
                    days.push({ date, isCurrentMonth: true, isToday: date.getTime() === today.getTime() });
                }
                const remainingCells = 42 - days.length;
                for (let i = 1; i <= remainingCells; i++) {
                    days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
                }
                return days;
            }, [currentDate, today]);

            if (isLoading) {
                return (
                    <div className="flex flex-col items-center justify-center min-h-screen">
                        <div className="loader"></div>
                        <div className="mt-4 text-lg font-semibold text-indigo-600">Загрузка графика...</div>
                    </div>
                );
            }

            return (
                <div className="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">
                    <div className="w-full max-w-4xl bg-white rounded-2xl shadow-xl p-4 sm:p-6">
                        <header className="flex items-center justify-between mb-4">
                            <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-indigo-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
                            </button>

                            <h2 className="text-lg sm:text-xl font-bold text-indigo-800 text-center capitalize">
                                {currentDate.toLocaleString('ru-RU', { month: 'long' })} {currentDate.getFullYear()}
                            </h2>
                            
                            <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-indigo-50 transition-colors">
                                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-indigo-600" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
                            </button>
                        </header>

                        <div className="calendar-grid text-xs sm:text-sm text-center font-bold text-indigo-900 mb-2">
                            <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
                        </div>

                       <div className="calendar-grid">
  {calendarDays.map(({ date, isCurrentMonth, isToday }) => {
    const key = date.toISOString().split('T')[0];
    const selectedPerson = schedule[key];
    const isPast = date.getTime() < today.getTime();

    const dayClass = `aspect-square flex flex-col justify-start items-center p-1 sm:p-2 border transition-all duration-200 rounded-lg ${
      isCurrentMonth
        ? selectedPerson
          ? 'bg-gradient-to-br from-violet-50 to-purple-50 border-violet-200'
          : 'bg-white border-slate-200 hover:bg-indigo-50'
        : 'bg-slate-100 text-slate-400 border-transparent'
    }`;
    
    const dateTextClass = `w-7 h-7 flex items-center justify-center rounded-full text-sm sm:text-base font-medium ${
      isCurrentMonth ? 'text-indigo-800' : 'text-slate-400'
    } ${isToday ? 'bg-gradient-to-r from-purple-500 to-indigo-600 text-white font-bold shadow-md scale-110' : ''}`;
    
    const selectClass = `w-full mt-0.5 text-xs sm:text-sm bg-transparent focus:outline-none text-center cursor-pointer truncate py-1 font-medium ${
      selectedPerson ? 'text-purple-700 font-semibold' : 'text-slate-600'
    }`;

    return (
   <div key={key} className={dayClass}>
  <time dateTime={key} className={dateTextClass}>
    {date.getDate()}
  </time>
  {isCurrentMonth && selectedPerson && (
    <>
      {/* Сегодня или прошлое → зелёная */}
      {(isPast || isToday) && (
        <div className="my-0.5 w-2 h-2 bg-green-500 rounded-full" title="Дежурство завершено"></div>
      )}
      {/* Будущее → жёлтая */}
      {!isPast && !isToday && (
        <div className="my-0.5 w-2 h-2 bg-yellow-500 rounded-full" title="Дежурство запланировано"></div>
      )}
    </>
  )}
  {isCurrentMonth && (
    <div className="w-full mt-auto">
      <select
        value={selectedPerson || ''}
        onChange={(e) => handleSelectPerson(date, e.target.value)}
        className={selectClass}
        aria-label={`Назначить дежурного на ${key}`}
      >
        <option value=""></option>
        {NAMES.map(name => <option key={name} value={name}>{name}</option>)}
      </select>
    </div>
  )}
</div>

    );
  })}
</div>

                        {isSaving && <div className="absolute bottom-4 right-4 text-xs text-violet-600 font-medium animate-pulse">Сохранение...</div>}
                    </div>
                </div>
            );
        };

        const rootElement = document.getElementById('root');
        const root = ReactDOM.createRoot(rootElement);
        root.render(<App />);
    </script>
</body>

</html>
