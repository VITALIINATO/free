<!DOCTYPE html>
<html lang="ru">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>График дежурств</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    body {
      -webkit-font-smoothing: antialiased;
      -moz-osx-font-smoothing: grayscale;
    }
    .calendar-grid {
      display: grid;
      grid-template-columns: repeat(7, minmax(0, 1fr));
    }
    /* Простая анимация для загрузчика */
    @keyframes spin {
      to { transform: rotate(360deg); }
    }
    .loader {
      border: 4px solid rgba(0, 0, 0, 0.1);
      border-left-color: #4f46e5;
      border-radius: 50%;
      width: 40px;
      height: 40px;
      animation: spin 1s linear infinite;
    }
  </style>
<script type="importmap">
{
  "imports": {
    "react": "https://aistudiocdn.com/react@^19.2.0",
    "react-dom/": "https://aistudiocdn.com/react-dom@^19.2.0/",
    "react/": "https://aistudiocdn.com/react@^19.2.0/"
  }
}
</script>
</head>
<body class="bg-slate-50">
  <div id="root"></div>

  <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
  <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
  <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>

  <script type="text/babel">
    const { useState, useEffect, useMemo, useCallback } = React;
    
    // --- ШАГ 2: ВСТАВЬТЕ ВАШ URL ИЗ KVdb.io ЗДЕСЬ ---
    const SCHEDULE_API_URL = "https://kvdb.io/XXNk2AAo7MEDxed7bQD9NN/schedule"; 
    // Например: "https://kvdb.io/AbCdEfGhIjKlMnOp/schedule"
    // ----------------------------------------------------

    const NAMES = [
      'ТЕСЛА', 'НИК', 'НАТО', 'ФИМА'
    ];

    const App = () => {
      const [currentDate, setCurrentDate] = useState(new Date());
      const [schedule, setSchedule] = useState({});
      const [isLoading, setIsLoading] = useState(true);
      const [isSaving, setIsSaving] = useState(false);

      // Загрузка данных при первом рендере
      useEffect(() => {
        const fetchSchedule = async () => {
          setIsLoading(true);
          try {
            // ИЗМЕНЕНИЕ: Добавлен { cache: 'no-cache' } для предотвращения кэширования браузером
            const response = await fetch(SCHEDULE_API_URL, { cache: 'no-cache' });
            // kvdb возвращает 404 если ключ не найден, это нормально для первого раза
            if (response.ok) {
              const data = await response.json();
              setSchedule(data);
            } else if (response.status !== 404) {
               throw new Error(`HTTP error! status: ${response.status}`);
            }
          } catch (error) {
            console.error("Не удалось загрузить график:", error);
            // Можно показать пользователю сообщение об ошибке
          } finally {
            setIsLoading(false);
          }
        };
        fetchSchedule();
      }, []);
      
      const saveSchedule = useCallback(async (newSchedule) => {
        setIsSaving(true);
        try {
          await fetch(SCHEDULE_API_URL, {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json'
            },
            body: JSON.stringify(newSchedule)
          });
        } catch (error) {
          console.error("Ошибка сохранения графика:", error);
        } finally {
          setIsSaving(false);
        }
      }, []);

      const handleSelectPerson = useCallback((date, person) => {
        const key = date.toISOString().split('T')[0];
        
        setSchedule(prevSchedule => {
          const newSchedule = { ...prevSchedule };
          if (person) {
            newSchedule[key] = person;
          } else {
            delete newSchedule[key]; // Удаляем ключ, если человек не выбран
          }
          saveSchedule(newSchedule); // Сохраняем полное расписание
          return newSchedule;
        });
      }, [saveSchedule]);

      const changeMonth = (offset) => {
        setCurrentDate(prevDate => {
          const newDate = new Date(prevDate.getFullYear(), prevDate.getMonth() + offset, 1);
          return newDate;
        });
      };
      
      const calendarDays = useMemo(() => {
        const year = currentDate.getFullYear();
        const month = currentDate.getMonth();
        const firstDayOfMonth = new Date(year, month, 1);
        const lastDayOfMonth = new Date(year, month + 1, 0);
        const daysInMonth = lastDayOfMonth.getDate();
        const startDayOfWeek = firstDayOfMonth.getDay();
        const days = [];
        const today = new Date();
        today.setHours(0, 0, 0, 0);
        const prevMonthLastDay = new Date(year, month, 0).getDate();
        for (let i = startDayOfWeek === 0 ? 6 : startDayOfWeek - 1; i > 0; i--) {
          days.push({ date: new Date(year, month - 1, prevMonthLastDay - i + 1), isCurrentMonth: false });
        }
        for (let i = 1; i <= daysInMonth; i++) {
          const date = new Date(year, month, i);
          days.push({ date, isCurrentMonth: true, isToday: date.getTime() === today.getTime() });
        }
        const remainingCells = 42 - days.length;
        for (let i = 1; i <= remainingCells; i++) {
          days.push({ date: new Date(year, month + 1, i), isCurrentMonth: false });
        }
        return days;
      }, [currentDate]);
      
      if (isLoading) {
        return (
            <div className="flex flex-col items-center justify-center min-h-screen">
                <div className="loader"></div>
                <div className="mt-4 text-lg font-semibold text-slate-500">Загрузка графика...</div>
            </div>
        );
      }

      return (
        <div className="flex flex-col items-center justify-center min-h-screen p-2 sm:p-4">
          <div className="w-full max-w-4xl bg-white rounded-2xl shadow-lg p-4 sm:p-6">
            <header className="flex items-center justify-between mb-4">
              <button onClick={() => changeMonth(-1)} className="p-2 rounded-full hover:bg-slate-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M15 19l-7-7 7-7" /></svg>
              </button>
              <h2 className="text-lg sm:text-xl font-semibold text-slate-700 text-center capitalize">
                {currentDate.toLocaleString('ru-RU', { month: 'long', year: 'numeric' })}
              </h2>
              <button onClick={() => changeMonth(1)} className="p-2 rounded-full hover:bg-slate-100 transition-colors">
                <svg xmlns="http://www.w3.org/2000/svg" className="h-6 w-6 text-slate-500" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path strokeLinecap="round" strokeLinejoin="round" strokeWidth={2} d="M9 5l7 7-7 7" /></svg>
              </button>
            </header>

            <div className="calendar-grid text-xs sm:text-sm text-center font-medium text-slate-500 mb-2">
              <div>Пн</div><div>Вт</div><div>Ср</div><div>Чт</div><div>Пт</div><div>Сб</div><div>Вс</div>
            </div>

            <div className="calendar-grid">
              {calendarDays.map(({ date, isCurrentMonth, isToday }) => {
                const key = date.toISOString().split('T')[0];
                const selectedPerson = schedule[key];
                const dayClass = `relative aspect-square flex flex-col justify-start items-center p-1 sm:p-2 border border-transparent transition-colors duration-200 rounded-lg ${ isCurrentMonth ? 'bg-white hover:bg-slate-50' : 'bg-slate-50' }`;
                const dateTextClass = `w-7 h-7 flex items-center justify-center rounded-full text-sm sm:text-base ${ isCurrentMonth ? 'text-slate-600' : 'text-slate-400' } ${ isToday ? 'bg-indigo-600 text-white font-bold' : '' }`;
                
                return (
                  <div key={key} className={dayClass}>
                    <time dateTime={key} className={dateTextClass}>
                      {date.getDate()}
                    </time>
                    {isCurrentMonth && (
                      <div className="w-full mt-1 sm:mt-2 flex-grow">
                        <select
                          value={selectedPerson || ''}
                          onChange={(e) => handleSelectPerson(date, e.target.value)}
                          className="w-full text-xs sm:text-sm bg-transparent text-slate-700 focus:outline-none text-center appearance-none cursor-pointer truncate"
                          aria-label={`Assign person for ${key}`}
                        >
                          <option value="">-</option>
                          {NAMES.map(name => <option key={name} value={name}>{name}</option>)}
                        </select>
                      </div>
                    )}
                    {selectedPerson && isCurrentMonth && <div className="absolute bottom-1.5 sm:bottom-2 w-1.5 h-1.5 bg-green-500 rounded-full"></div>}
                  </div>
                );
              })}
            </div>
            {isSaving && <div className="absolute bottom-4 right-4 text-xs text-slate-400">Сохранение...</div>}
          </div>
        </div>
      );
    };

    const rootElement = document.getElementById('root');
    const root = ReactDOM.createRoot(rootElement);
    root.render(<App />);
  </script>
</body>
</html>
